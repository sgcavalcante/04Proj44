{% extends "base.html" %}
{% load static %}
{% block conteudo %}
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet" />

  <div class="content-container">
    <h1 class="mb-4">Agendar Consulta para {{ paciente.nome }}</h1>
    <!-- Formulário oculto -->
    <form method="post" id="agendar-consulta-form" class="d-none">
      {% csrf_token %}
      <input type="hidden" id="id_data_horario" name="data_horario">
      <input type="hidden" id="id_data_horario_end" name="data_horario_end">
      <input type="hidden" id="id_descricao" name="descricao" value="Consulta automática">
    </form>

    <!-- Calendário -->
    <div id="calendar" class="mx-auto" style="max-width: 1100px;"></div>
  </div>

  <!-- FullCalendar e dependências -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/pt-br.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // helper para montar a string ISO local (sem Z nem offset)
function formatLocal(date) {
  const pad = n => String(n).padStart(2,'0');
  return date.getFullYear() + '-'
       + pad(date.getMonth()+1) + '-'
       + pad(date.getDate()) + 'T'
       + pad(date.getHours()) + ':'
       + pad(date.getMinutes()) + ':00';
}

document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const $form = $('#agendar-consulta-form');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    locale: 'pt-br',
    events: '/eventos_consultas/',
    selectable: true,
    allDaySlot: false,
    slotDuration: '01:00:00',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },

    dateClick: function(info) {
      // pega o instante clicado em local
      let start = new Date(info.date);
      start.setMinutes(0,0,0);
      // fim = +1h
      let end = new Date(start.getTime() + 60*60*1000);

      // preenche os hidden com LOCAL ISO
      $('#id_data_horario').val( formatLocal(start) );
      $('#id_data_horario_end').val(   formatLocal(end) );
      $('#id_descricao').val('Consulta automática');

      // envia
      $.ajax({
        url: "{% url 'agendar_consulta' paciente.id %}",
        type: "POST",
        data: $form.serialize(),
        success: function() {
          calendar.refetchEvents();
          alert('Consulta marcada!');
        },
        error: function(xhr) {
          alert('Erro: '+xhr.responseJSON.error);
        }
      });
    }
  });

  calendar.render();
});

    </script>
{% endblock conteudo %}
