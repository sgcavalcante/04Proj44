{% extends "base.html" %}
{% load static %}
{% block conteudo %}
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet" />

  <div class="content-container">
    <h1 class="mb-4">Agendar Consulta para {{ paciente.nome }}</h1>
    <!-- Formulário oculto -->
    <form method="post" id="agendar-consulta-form" class="d-none">
      {% csrf_token %}
      <input type="hidden" id="id_data_horario" name="data_horario">
      <input type="hidden" id="id_data_horario_end" name="data_horario_end">
      <input type="hidden" id="id_descricao" name="descricao" value="Consulta automática">
    </form>

    <!-- Calendário -->
    <div id="calendar" class="mx-auto" style="max-width: 1100px;"></div>
  </div>

  <!-- FullCalendar e dependências -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/pt-br.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // helper para montar a string ISO local (sem Z nem offset)
function formatLocal(date) {
  const pad = n => String(n).padStart(2,'0');
  return date.getFullYear() + '-'
       + pad(date.getMonth()+1) + '-'
       + pad(date.getDate()) + 'T'
       + pad(date.getHours()) + ':'
       + pad(date.getMinutes()) + ':00';
}

document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');
  var $form     = $('#agendar-consulta-form');

  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView:     'timeGridWeek',
    locale:          'pt-br',
    slotDuration:    '01:00:00',
    selectable:      false,  // não precisamos mais de select
    headerToolbar: {
      left:   'prev,next today',
      center: 'title',
      right:  'dayGridMonth,timeGridWeek,timeGridDay'
    },
    events: '/eventos_consultas/',

    // captura clique em evento
    eventClick: function(info) {
      // só agendar se for um slot livre
      if (info.event.extendedProps.type === 'free') {
        // evita ação padrão
        info.jsEvent.preventDefault();

        // preenche o form
        var start = info.event.start;
        var end   = info.event.end;
        function fmt(d) {
          const pad = n=>String(n).padStart(2,'0');
          return d.getFullYear() + '-'
               + pad(d.getMonth()+1) + '-'
               + pad(d.getDate()) + 'T'
               + pad(d.getHours()) + ':'
               + pad(d.getMinutes()) + ':00';
        }
        $('#id_data_horario').val( fmt(start) );
        $('#id_data_horario_end').val(   fmt(end) );
        $('#id_descricao').val('Consulta automática');

        // envia AJAX
        $.ajax({
          url:   "{% url 'agendar_consulta' paciente.id %}",
          type:  "POST",
          data:  $form.serialize(),
          success: function() {
            alert('Consulta agendada!');
            calendar.refetchEvents();
          },
          error: function(xhr) {
            alert('Erro: ' + xhr.responseJSON.error);
          }
        });
      }
    }
  });

  calendar.render();
});
    </script>
{% endblock conteudo %}
